# =============================================================================
# GitHub Actions — Pipeline CI
# =============================================================================
#
# Exécute le linter (Biome) et les tests (unitaires + intégration) sur chaque
# push et pull request. Le pipeline bloque le merge en cas d'échec.
#
# La base de données de test est lancée via docker compose (même config qu'en
# local) avec tmpfs pour la rapidité.
# =============================================================================

name: CI

on:
  push:
  pull_request:
    branches: [dev, main]

jobs:
  ci:
    runs-on: ubuntu-latest
    env:
      GEMINI_API_KEY: test-key-ci

    steps:
      # ── 1. Récupérer le code ───────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ── 2. Installer Node.js ───────────────────────────────────────────
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22

      # ── 3. Installer les dépendances ───────────────────────────────────
      - name: Install root dependencies
        run: npm ci

      - name: Install service dependencies
        run: |
          npm ci --prefix writer/backend
          npm ci --prefix reader/backend
          npm ci --prefix writer/frontend
          npm ci --prefix reader/frontend

      # ── 4. Générer le client Prisma ────────────────────────────────────
      - name: Generate Prisma Client
        run: npx prisma generate
        working-directory: reader/backend

      # ── 5. Linter ─────────────────────────────────────────────────────
      - name: Lint (Biome)
        run: npm run lint

      # ── 6. Démarrer la base de données de test ────────────────────────
      - name: Start test database
        run: npm run test:db:up

      # ── 7. Tests backend ──────────────────────────────────────────────
      - name: Test writer backend
        run: npm test --prefix writer/backend

      - name: Test reader backend
        run: npm test --prefix reader/backend

      # ── 8. Tests frontend (composants) ────────────────────────────────
      - name: Test writer frontend
        run: npm test --prefix writer/frontend

      - name: Test reader frontend
        run: npm test --prefix reader/frontend

      # ── 9. Cleanup ────────────────────────────────────────────────────
      - name: Stop test database
        if: always()
        run: npm run test:db:down
